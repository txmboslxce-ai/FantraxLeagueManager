{% extends "base.html" %}

{% block content %}
<style>
    /* Modern mobile-first styles */
    .table-container {
        background: #fff;
        border-radius: 12px;
        overflow: hidden;
        margin-bottom: 1rem;
    }
    
    .view-selector {
        background: #f8f9fa;
        padding: 0.5rem;
        border-radius: 8px;
        margin-bottom: 1rem;
        display: flex;
        gap: 0.5rem;
    }
    
    .view-selector button {
        flex: 1;
        padding: 0.5rem;
        border: none;
        background: transparent;
        color: #666;
        font-weight: 500;
    }
    
    .view-selector button.active {
        background: #fff;
        color: #000;
        border-radius: 6px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }

    .table-modern {
        width: 100%;
        border-collapse: collapse;
    }

    .table-modern tr {
        border-bottom: 1px solid #f0f0f0;
    }

    .table-modern tr:last-child {
        border-bottom: none;
    }

    .table-modern td, 
    .table-modern th {
        padding: 0.75rem 0.5rem;
        font-size: 0.9rem;
        white-space: nowrap;
    }

    .team-cell {
        display: flex;
        align-items: center;
        gap: 1rem;
    }

    .team-info {
        display: flex;
        flex-direction: column;
    }

    .position {
        width: 24px;
        height: 24px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        font-size: 0.8rem;
        font-weight: 500;
    }

    .position-first {
        background: #FFD700;
        color: black;
    }

    .position-normal {
        background: #f0f0f0;
        color: #666;
    }

    .team-name {
        font-weight: 500;
        color: #000;
        text-decoration: none;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        max-width: 150px;
        display: block;
    }

    .manager-name {
        font-size: 0.8rem;
        color: #666;
    }

    .division-name {
        font-size: 0.75rem;
        color: #999;
    }

    /* Stats view specific styles */
    .stats-view .hide-stats {
        display: none;
    }

    /* Form view specific styles */
    .form-view .hide-form {
        display: none;
    }

    .form-indicator {
        width: 20px;
        height: 20px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        font-size: 0.7rem;
        font-weight: 500;
        margin: 0 1px;
    }

    .form-W {
        background: #00b300;
        color: white;
    }

    .form-D {
        background: #666;
        color: white;
    }

    .form-L {
        background: #ff0000;
        color: white;
    }

    .month-header {
        font-size: 1.25rem;
        margin-bottom: 0.25rem;
    }

    .month-info {
        font-size: 0.85rem;
        color: #666;
        margin-bottom: 1rem;
    }

    @media (max-width: 768px) {
        .table-modern td, 
        .table-modern th {
            padding: 0.5rem 0.25rem;
            font-size: 0.85rem;
        }

        .position {
            width: 20px;
            height: 20px;
            font-size: 0.75rem;
        }

        .team-name {
            max-width: 100px;
        }

        .hide-mobile {
            display: table-cell !important;
        }

        .table-modern td.text-center {
            padding: 0.5rem 0.15rem;
        }

        .manager-name {
            font-size: 0.75rem;
        }

        .division-name {
            font-size: 0.7rem;
        }
    }
</style>

<div class="container">
    <h1 class="month-header">Manager of the Month</h1>

    {% if season %}
    <div class="row mb-4">
        <div class="col-9">
            <form method="GET">
                <select name="month_id" class="form-select" onchange="this.form.submit()">
                    <option value="">Select Month</option>
                    {% for m in months|sort(attribute='start_gameweek.number', reverse=true) %}
                        {% set standings = m.get_standings() %}
                        {% if standings %}
                            <option value="{{ m.id }}" {% if selected_month and selected_month.id == m.id %}selected{% endif %}>
                                {{ m.name }} - {{ season.name }}{% if not m.has_fixtures %} (In Progress){% endif %}
                            </option>
                        {% endif %}
                    {% endfor %}
                </select>
            </form>
        </div>
        <div class="col-3">
            <a href="{{ url_for('main.motm_winners') }}" class="btn btn-outline-primary w-100">
                <i class="fas fa-trophy me-2"></i>Previous Winners
            </a>
        </div>
    </div>

    {% if selected_month %}
    <div class="month-info">
        Gameweeks {{ selected_month.start_gameweek.number }} - {{ selected_month.end_gameweek.number }}
        {% if not selected_month.has_fixtures %}(In Progress){% endif %}
    </div>

    <div class="view-selector">
        <button type="button" class="active" onclick="switchView('stats')">Stats</button>
        <button type="button" onclick="switchView('form')">Form</button>
    </div>

    <div class="table-container">
        <table class="table-modern stats-view">
            <thead>
                <tr>
                    <th style="width: 40%">Team</th>
                    <th class="text-center">P</th>
                    <th class="text-center hide-mobile hide-form">W</th>
                    <th class="text-center hide-mobile hide-form">D</th>
                    <th class="text-center hide-mobile hide-form">L</th>
                    <th class="text-center hide-stats">Form</th>
                    <th class="text-center hide-form">PF</th>
                    <th class="text-center">Pts</th>
                </tr>
            </thead>
            <tbody>
                {% set standings = selected_month.get_standings() %}
                {% for standing in standings %}
                <tr>
                    <td>
                        <div class="team-cell">
                            <div class="position {% if loop.index == 1 %}position-first{% else %}position-normal{% endif %}">
                                {{ loop.index }}
                            </div>
                            <div class="team-info">
                                <a href="{{ url_for('main.team_profile', team_id=standing.team.id) }}" class="team-name">
                                    {{ standing.team.name }}
                                </a>
                                <span class="manager-name">{{ standing.team.manager_name }}</span>
                                {% set team_season = standing.team.seasons|selectattr('season_id', 'eq', season.id)|first %}
                                <span class="division-name">{{ team_season.division.name }}</span>
                            </div>
                        </div>
                    </td>
                    <td class="text-center">{{ standing.played }}</td>
                    <td class="text-center hide-mobile hide-form">{{ standing.wins }}</td>
                    <td class="text-center hide-mobile hide-form">{{ standing.draws }}</td>
                    <td class="text-center hide-mobile hide-form">{{ standing.losses }}</td>
                    <td class="text-center hide-stats">
                        {% set month_fixtures = [] %}
                        {% for fixture in standing.team.home_fixtures %}
                            {% if fixture.gameweek.number >= selected_month.start_gameweek.number and fixture.gameweek.number <= selected_month.end_gameweek.number and fixture.home_score is not none %}
                                {% set _ = month_fixtures.append({'fixture': fixture, 'is_home': true, 'gameweek': fixture.gameweek.number}) %}
                            {% endif %}
                        {% endfor %}
                        {% for fixture in standing.team.away_fixtures %}
                            {% if fixture.gameweek.number >= selected_month.start_gameweek.number and fixture.gameweek.number <= selected_month.end_gameweek.number and fixture.home_score is not none %}
                                {% set _ = month_fixtures.append({'fixture': fixture, 'is_home': false, 'gameweek': fixture.gameweek.number}) %}
                            {% endif %}
                        {% endfor %}
                        {% set sorted_fixtures = month_fixtures|sort(attribute='gameweek') %}
                        {% for f in sorted_fixtures[-5:] %}
                            {% if f.is_home %}
                                {% if f.fixture.home_score > f.fixture.away_score %}
                                    <span class="form-indicator form-W">W</span>
                                {% elif f.fixture.home_score < f.fixture.away_score %}
                                    <span class="form-indicator form-L">L</span>
                                {% else %}
                                    <span class="form-indicator form-D">D</span>
                                {% endif %}
                            {% else %}
                                {% if f.fixture.away_score > f.fixture.home_score %}
                                    <span class="form-indicator form-W">W</span>
                                {% elif f.fixture.away_score < f.fixture.home_score %}
                                    <span class="form-indicator form-L">L</span>
                                {% else %}
                                    <span class="form-indicator form-D">D</span>
                                {% endif %}
                            {% endif %}
                        {% endfor %}
                    </td>
                    <td class="text-center hide-form">{{ "%.2f"|format(standing.goals_for) }}</td>
                    <td class="text-center"><strong>{{ standing.points }}</strong></td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% endif %}
    {% else %}
    <div class="alert alert-info">
        <p class="mb-0">No active season found. Please contact the administrator to set up a new season.</p>
    </div>
    {% endif %}
</div>

<script>
function switchView(view) {
    const table = document.querySelector('.table-modern');
    const buttons = document.querySelectorAll('.view-selector button');
    
    buttons.forEach(btn => btn.classList.remove('active'));
    document.querySelector(`button[onclick="switchView('${view}')"]`).classList.add('active');
    
    if (view === 'stats') {
        table.classList.remove('form-view');
        table.classList.add('stats-view');
    } else {
        table.classList.remove('stats-view');
        table.classList.add('form-view');
    }
}
</script>
{% endblock %} 