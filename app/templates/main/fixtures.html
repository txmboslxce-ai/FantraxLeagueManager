{% extends "base.html" %}

{% block content %}
<style>
    /* Modern mobile-first styles */
    .container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 1rem;
    }

    .filter-section {
        background: #fff;
        border-radius: 12px;
        padding: 1rem;
        margin-bottom: 2rem;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    
    .filter-grid {
        display: grid;
        gap: 1rem;
        /* Default: single row for fixtures (3 filters) */
        grid-template-columns: repeat(3, 1fr);
    }
    
    /* Results page: 2x2 grid for 4 filters */
    .results-page .filter-grid {
        grid-template-columns: repeat(2, 1fr);
    }

    .gameweek-section {
        margin-bottom: 2rem;
    }

    .gameweek-title {
        font-size: 1.5rem;
        font-weight: 600;
        margin-bottom: 1.5rem;
        color: #333;
    }

    .division-title {
        font-size: 1.25rem;
        font-weight: 500;
        margin: 1.5rem 0 1rem;
        color: #333;
    }

    .fixtures-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        gap: 1rem;
        margin-bottom: 2rem;
    }

    .fixture-card {
        background: #fff;
        border: 1px solid #e0e0e0;
        border-radius: 8px;
        overflow: hidden;
    }

    .fixture-body {
        padding: 1rem;
    }

    .fixture-table {
        width: 100%;
        font-size: 0.85rem;
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
    }

    .fixture-table td {
        padding: 0.5rem;
        vertical-align: middle;
    }

    .team-name {
        font-weight: 500;
        color: #333;
        text-decoration: none;
        font-size: 0.85rem;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        max-width: 200px;
        display: inline-block;
    }

    .team-name:hover {
        color: #000;
        text-decoration: none;
    }

    .score-badge {
        display: inline-block;
        min-width: 3rem;
        padding: 0.2rem 0.4rem;
        font-size: 0.85rem;
        text-align: center;
        border-radius: 4px;
    }

    .score-badge.winner {
        background: #e8f5e9;
        color: #2e7d32;
        font-weight: 500;
    }

    .score-badge.loser {
        background: #fbe9e7;
        color: #d32f2f;
    }

    .score-badge.draw {
        background: #f5f5f5;
        color: #616161;
    }

    .score-badge.pending {
        background: #f5f5f5;
        color: #9e9e9e;
    }

    @media (max-width: 768px) {
        .filter-grid,
        .results-page .filter-grid {
            grid-template-columns: 1fr;
        }

        .fixtures-grid {
            grid-template-columns: 1fr;
        }

        .team-name {
            font-size: 0.8rem;
            max-width: 150px;
        }

        .score-badge {
            min-width: 2.5rem;
            font-size: 0.8rem;
        }
    }
</style>

<h1 class="gameweek-title">{{ title }}</h1>

{% if season %}
<div class="filter-section{% if title == 'Results' %} results-page{% endif %}">
    <form method="GET" id="filterForm">
        <div class="filter-grid">
            {% if title == 'Results' %}
            <select name="season_id" class="form-select" onchange="this.form.submit()">
                {% for s in all_seasons %}
                <option value="{{ s.id }}" {% if s.id == season.id %}selected{% endif %}>
                    {{ s.name }}
                </option>
                {% endfor %}
            </select>
            {% endif %}

            <select name="gameweek" class="form-select" onchange="this.form.submit()">
                <option value="">All Gameweeks</option>
                {% for gw in gameweeks %}
                <option value="{{ gw.number }}" {% if selected_gameweek == gw.number %}selected{% endif %}>
                    Gameweek {{ gw.number }}
                </option>
                {% endfor %}
            </select>

            <select name="division" class="form-select" onchange="updateTeamsAndSubmit()">
                <option value="">All Divisions</option>
                {% for division in divisions %}
                <option value="{{ division.id }}" {% if selected_division_id == division.id %}selected{% endif %}>
                    {{ division.name }}
                </option>
                {% endfor %}
            </select>

            <select name="team" class="form-select" onchange="this.form.submit()">
                <option value="">All Teams</option>
                {% for team in teams %}
                <option value="{{ team.id }}" {% if selected_team_id == team.id %}selected{% endif %}>
                    {{ team.name }}
                </option>
                {% endfor %}
            </select>
        </div>
    </form>
</div>

{% set fixtures_by_gameweek = {} %}
{% for fixture in fixtures %}
    {% if fixture.gameweek.number not in fixtures_by_gameweek %}
        {% set _ = fixtures_by_gameweek.update({fixture.gameweek.number: {}}) %}
    {% endif %}
    {% if fixture.division.name not in fixtures_by_gameweek[fixture.gameweek.number] %}
        {% set _ = fixtures_by_gameweek[fixture.gameweek.number].update({fixture.division.name: []}) %}
    {% endif %}
    {% set _ = fixtures_by_gameweek[fixture.gameweek.number][fixture.division.name].append(fixture) %}
{% endfor %}

{% if title == 'Results' %}
    {% set sorted_gameweeks = fixtures_by_gameweek|sort(reverse=true) %}
{% else %}
    {% set sorted_gameweeks = fixtures_by_gameweek|sort %}
{% endif %}

{% for gameweek_number in sorted_gameweeks %}
<div class="gameweek-section">
    <h2 class="gameweek-title">Gameweek {{ gameweek_number }}</h2>
    {% for division_name in fixtures_by_gameweek[gameweek_number].keys()|sort %}
    <div class="division-section">
        <h3 class="division-title">{{ division_name }}</h3>
        <div class="fixtures-grid">
            {% for fixture in fixtures_by_gameweek[gameweek_number][division_name] %}
            <div class="fixture-card">
                <div class="fixture-body">
                    <table class="fixture-table">
                        <tr>
                            <td style="width: 70%">
                                <a href="{{ url_for('main.team_profile', team_id=fixture.home_team_id) }}" class="team-name">
                                    {{ fixture.home_team.name }}
                                </a>
                            </td>
                            <td class="text-center" style="width: 30%">
                                {% if fixture.home_score is not none and fixture.away_score is not none %}
                                    <span class="score-badge {% if fixture.home_score > fixture.away_score %}winner{% elif fixture.home_score < fixture.away_score %}loser{% else %}draw{% endif %}">
                                        {{ "%.2f"|format(fixture.home_score) }}
                                    </span>
                                {% else %}
                                    <span class="score-badge pending">-</span>
                                {% endif %}
                            </td>
                        </tr>
                        <tr>
                            <td>
                                <a href="{{ url_for('main.team_profile', team_id=fixture.away_team_id) }}" class="team-name">
                                    {{ fixture.away_team.name }}
                                </a>
                            </td>
                            <td class="text-center">
                                {% if fixture.home_score is not none and fixture.away_score is not none %}
                                    <span class="score-badge {% if fixture.away_score > fixture.home_score %}winner{% elif fixture.away_score < fixture.home_score %}loser{% else %}draw{% endif %}">
                                        {{ "%.2f"|format(fixture.away_score) }}
                                    </span>
                                {% else %}
                                    <span class="score-badge pending">-</span>
                                {% endif %}
                            </td>
                        </tr>
                    </table>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endfor %}
</div>
{% endfor %}

{% else %}
<div class="alert alert-info">
    <p class="mb-0">No active season found. Please contact the administrator to set up a new season.</p>
</div>
{% endif %}

<script>
function updateTeamsAndSubmit() {
    document.getElementById('filterForm').submit();
}
</script>
{% endblock %}